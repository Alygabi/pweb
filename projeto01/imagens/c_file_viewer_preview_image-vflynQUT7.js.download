!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="97a32931-f10a-3744-afbd-48b94b94a186")}catch(e){}}();
define(["require","exports","react","./c_core_i18n","./e_file_viewer_static_scl_page_file","./c_core_utils_branding","./c_file_viewer_ui_header","./e_core_exception","./c_src_sink_index","./c_browser_browser_detection","./c_lodash-es_lodash","./c_memoize-one","metaserver/static/js/langpack","./c_init_data_edison","./c_init_data_debug_panel","./e_edison","./c_api_v2_routes_password_confirmation_provider","./c_pap-events_navigation_select_create_folder_action","./e_data_modules_stormcrow","./c_react-use_misc_util","./c_api_v2_client_base","./c_watermarking_utils_getImageDefaultSizes","./c_core_notify","react-dom","./c_security_csrf_hmac"],(function(e,t,i,a,o,n,r,l,s,c,d,u,m,g,_,v,f,h,p,w,y,E,S,b,I){"use strict";function A(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var a=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,a.get?a:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var P=A(i);async function z(e,t,i){try{const a=await fetch(e,{credentials:"include",signal:t});return 200!==a.status&&400!==a.status?(null==i||i(new Error(`Motion photo request failed: status ${a.status}`)),null):await a.arrayBuffer()}catch(e){if(e instanceof Error){if(e instanceof DOMException&&"AbortError"===e.name)return null;null==i||i(e)}else null==i||i(new Error("Unknown error fetching motion photo"));return null}}const k=P.default.lazy((()=>new Promise((function(t,i){e(["./c_file_viewer_preview_image_motion_photo"],t,i)})).then((e=>({default:e.MotionPhoto}))))),L=({layerViewportScale:e,photoSrc:t,videoSrc:a,filename:n})=>{var r;const[l,s]=i.useState(null),[c,d]=i.useState(null),{logUserAction:u,optionalIOClients:m}=o.useFileViewerContext(),g=null===(r=m.reportExceptionClient)||void 0===r?void 0:r.reportException,_=i.useCallback((e=>{null==g||g(e,"image",n?o.getWhitelistedFileExtension(o.file_extension(n)):"unknown","non-critical")}),[g,n]),v=i.useCallback((()=>{u(o.UserAction.MotionPhotoRequestPlay)}),[u]),f=i.useCallback((()=>{u(o.UserAction.MotionPhotoReady)}),[u]);return i.useEffect((()=>{const e=new AbortController,i=e.signal;return(async()=>{d(await z(a,i,_))})(),(async()=>{s(await z(t,i,_))})(),()=>{e.abort()}}),[t,a,_]),P.default.createElement(P.default.Suspense,{fallback:null},P.default.createElement(k,{layerViewportScale:e,photoBytes:l,videoBytes:c,onRequestPlay:v,onReady:f,onError:_}))};L.displayName="LazyMotionPhoto";const M=({fileInfo:e,layerViewportScale:t,photoSrc:i,videoSrc:a,filename:n})=>function(e){const{data:t}=o.useFileContentMetadataQuery(e);return t&&t.apiData?!!("image"===t.apiData.metadata[".tag"]&&t.apiData.metadata.motion_photo&&t.apiData.metadata.dbx_video_offset&&t.apiData.metadata.dbx_video_size):null}({fileId:e.file_id,url:e.url})?P.default.createElement(L,{layerViewportScale:t,photoSrc:i,videoSrc:a,filename:n}):null;M.displayName="MaybeMotionPhoto";o.injectInternalStyle("/static/js/file_viewer/preview_image/preview_image.module.out-vflj5LlGE.css",(e=>"._viewport_vfeu6_1{box-sizing:border-box;height:100%;overflow:auto;position:relative;width:100%}._loader_vfeu6_9{left:50%;position:absolute;top:50%}._fullSizeImg_vfeu6_16,._smallImg_vfeu6_15{height:100%;position:absolute;width:100%}._sizer_vfeu6_24{position:absolute}._viewport_vfeu6_1._zoomFit_vfeu6_33 ._sizer_vfeu6_24{bottom:0;left:0;margin:auto;right:0;top:0}._layer_vfeu6_41{height:100%;left:0;position:absolute;top:0;width:100%}._mobileImageContainer_vfeu6_49{align-self:baseline;display:flex;flex-direction:column;height:100%;margin:auto}._mobileImageContainer_vfeu6_49 img{height:100%;max-height:100%;max-width:100%;object-fit:contain;width:100%}._app_vfeu6_65{align-items:flex-end;display:flex;flex-grow:1;height:100%;justify-content:center;position:relative;width:100%}"));const C="_fullSizeImg_vfeu6_16",x="_layer_vfeu6_41",N=e=>{var t,i,a;const{onSmallImageLoaded:n,onFullSizeImageLoaded:r,previewKey:l,className:s,previewMetadata:c,layerViewportScale:d,fileMetadata:u,activeOverlay:m}=e,[g,_]=P.useState(!1),[v,f]=P.useState(!0);P.useEffect((()=>{!g&&v||(_(!1),f(!0))}),[l.serialized]);const h=P.useCallback((({currentTarget:{naturalWidth:e,naturalHeight:t}})=>{f(!1),o.PreviewsEventLogger.mark(o.PreviewsTimingEvents.FVSDK_IMAGE_ON_LOAD),n(e,t)}),[]),p=P.useCallback((({currentTarget:{naturalWidth:e,naturalHeight:t}})=>{f(!1),_(!0),r(e,t),o.PreviewsEventLogger.mark(o.PreviewsTimingEvents.FVSDK_FULL_IMAGE_ON_LOAD)}),[]),w=(null===(t=null==c?void 0:c.dimensions)||void 0===t?void 0:t.width)&&(null===(i=c.dimensions)||void 0===i?void 0:i.height),y="image"===(null===(a=null==c?void 0:c.content)||void 0===a?void 0:a[".tag"])?c.content:void 0;if(!y)return null;const{default_src:E,src_set:S,full_size_src:b}=y,I=!m;if(w)return P.createElement("div",{className:x},P.createElement("img",{alt:null==u?void 0:u.file_name,className:o.cx(C,s),src:E,srcSet:S,sizes:d+"vw",onLoad:p,onError:e.onImageError,"data-testid":"fv-sdk-img-preview-full-size"}),I&&e.fileInfo&&E&&y.motion_photo_video_src&&P.createElement(M,{fileInfo:e.fileInfo,layerViewportScale:d,photoSrc:E,videoSrc:y.motion_photo_video_src,filename:null==u?void 0:u.file_name}));const A={display:"none"};return P.createElement("div",{className:x},P.createElement("img",{key:E,src:E,style:v?A:void 0,onLoad:h,className:o.cx("_smallImg_vfeu6_15",s),onError:e.onImageError,alt:null==u?void 0:u.file_name,"aria-hidden":!!g,"data-testid":"fv-sdk-img-preview-thumbnail"}),P.createElement("img",{key:b,alt:null==u?void 0:u.file_name,className:o.cx(C,s),src:b,style:g?void 0:A,onLoad:p,onError:e.onImageError,"data-testid":"fv-sdk-img-preview-full-size"}),I&&e.fileInfo&&E&&y.motion_photo_video_src&&P.createElement(M,{fileInfo:e.fileInfo,layerViewportScale:d,photoSrc:E,videoSrc:y.motion_photo_video_src,filename:null==u?void 0:u.file_name}))};N.displayName="ImageLayer";const O=["imageLayer"];const D=({scaleFactor:e,originalWidth:t,originalHeight:i,width:a,height:r,className:l,aspectRatio:s,verticalPadding:c,horizontalPadding:d,activeOverlayEditor:u,isEditing:m,brandingLogoAndSocials:g,children:_})=>{const v=P.useRef(null),f=P.useRef([.5,.5]);P.useLayoutEffect((()=>{v.current&&"function"==typeof v.current.scrollTo&&e&&t&&i&&v.current.scrollTo(...function(e,t,i,a){const{w:o,h:n}=i,{w:r,h:l}=a,s=t*o,c=t*n;return[e[0]*s-r/2,e[1]*c-l/2]}(f.current,e,{w:t,h:i},{w:a,h:r}))}),[e,t,i,r,a]);const h=P.useCallback((o=>{const{scrollLeft:n,scrollTop:l}=o.currentTarget;f.current=function(e,t,i,a){const{left:o,top:n}=e,{w:r,h:l}=t,{w:s,h:c}=i,d=[.5,.5];if(!r||!l||!a)return d;const u=r*a,m=l*a;return u>s&&(d[0]=(o+s/2)/u),m>c&&(d[1]=(n+c/2)/m),d}({left:n,top:l},{w:t,h:i},{w:a,h:r},e)}),[e,t,i,r,a]),p={width:t,height:i};if(e&&t&&i){const{width:n,height:l,translateX:s,translateY:c}=o.calculateImageSizerDimensions({width:t,height:i},{width:a,height:r},e);p.width=n,p.height=l,p.transform=`translate(${s}px, ${c}px)`}else if(s){const[e,t]=o.calculateFitBox(a-d,r-c,s);p.width=e,p.height=t}else p.visibility="hidden";const w=o.getImageSizeScale(Number(p.width)),y=!(u&&u.shouldReplacePreview);return P.createElement("div",{className:o.cx(l,"_viewport_vfeu6_1"),style:{width:a,height:r},onScroll:h,ref:v},P.createElement(n.BrandingLogoAndSocialsWrapper,{brandingLogoAndSocials:g,isEditing:m}),y?P.createElement("div",{className:o.cx("_sizer_vfeu6_24"),style:p},_({originalWidth:t||0,originalHeight:i||0,layerViewportScale:w,layerViewportRef:v})):_({originalWidth:t||0,originalHeight:i||0,layerViewportScale:w,layerViewportRef:v}))};function R(e){const t={width:void 0,height:void 0};return e&&e.dimensions?e.dimensions:t}D.displayName="Viewport";const F=({onRenderSucceeded:e,previewMetadata:t,featureConfig:i,previewKey:l,width:s,height:c,commentPlugin:d,activeOverlayEditor:u,fileInfo:m,fileMetadata:g,header:_,pluginActivationParams:v,isEditing:f,setLocalError:h,brandingBackground:p,brandingLogoAndSocials:w})=>{var y;const{logUserAction:E}=o.useFileViewerContext(),S=a.useIntl(),[b,I]=P.useState(),[A,z]=P.useState(),k=o.useIsCommentsModeActive(),L=o.useSetPreviewKeyAtom(o.imageLocalDimensionsAtom,l);P.useMemo((()=>{o.PreviewsEventLogger.mark(o.PreviewsTimingEvents.FVSDK_IMAGE_CONTAINER_START)}),[]),o.useMarkTimingEventOnMount(o.PreviewsTimingEvents.FVSDK_IMAGE_CONTAINER_MOUNT);const{originalWidth:M,originalHeight:C}=P.useMemo((()=>function(e,t){const{width:i,height:a}=R(e);return a&&i?{originalWidth:i,originalHeight:a}:{originalWidth:null==t?void 0:t.width,originalHeight:null==t?void 0:t.height}}(t,b)),[b,t]),x=P.useCallback(((e,t)=>{const i=e&&t?{height:t,width:e}:void 0;I(i),L(i)}),[L]),F=o.useUpdateZoomCallback(),T=o.useSetPreviewKeyAtom(o.fitScaleFactorAtom,l),V=o.useSetPreviewKeyAtom(o.fitToWidthScaleFactorAtom,l);P.useEffect((()=>{if(!M||!C)return;const e=function(e,t,i){return Math.min((t.width-i.horizontal)/e.width,(t.height-i.vertical)/e.height)}({width:M,height:C},{width:s,height:c},o.IMAGE_PADDING);T(e);const t=function(e,t,i){return(t-i)/e}(M,s,o.IMAGE_PADDING.horizontal);V(t),F(e>1?{zoomType:"zoomPercent",newZoom:1}:{zoomType:"fitToPage"})}),[c,C,M,T,V,F,s]),P.useEffect((()=>()=>L(void 0)),[L]);const U=o.useOnce((()=>{e()})),K=o.useStabilizedCallback(((e,t)=>{x(e,t),z(e/t),U()})),W=o.useStabilizedCallback(((e,t)=>{b||K(e,t)})),B=o.useStabilizedCallback((()=>h(new o.FVError(o.FVErrorCode.Unknown,o.ErrorLifecycle.Render)))),G=o.useSetFileViewerAtom(o.zoomInOrOutAtom),H=P.useMemo((()=>o.getZoomInOutBindings({zoomIn:()=>{G(!0),E(o.UserAction.ZoomIn,o.UserActionContext.Keyboard)},zoomOut:()=>{G(!1),E(o.UserAction.ZoomOut,o.UserActionContext.Keyboard)}})),[E,G]),j=function(e,t){const{width:i,height:a}=R(e);return null!=a&&null!=i?i/a:t}(t,A),Z=o.useZoomScaleFactor(),q=o.useRootImageUi(),$="image"===(null===(y=null==t?void 0:t.content)||void 0===y?void 0:y[".tag"])?t.content:void 0;return $?i.mobile_web?P.createElement(r.ContentHeader,{header:_,className:"_mobileImageContainer_vfeu6_49"},P.createElement("img",{onLoad:e,onError:B,src:$.full_size_src,alt:null==g?void 0:g.file_name,"data-testid":"fv-sdk-img-preview-full-size"})):P.createElement("div",{className:"_app_vfeu6_65"},P.createElement(r.ContentHeader,{header:_},P.createElement(o.KeyboardBindingConnector,{name:"preview_image",keyboardBindings:H}),P.createElement(n.BrandingBackgroundWrapper,{brandingBackground:p,isEditing:f},P.createElement(D,{originalWidth:M,originalHeight:C,scaleFactor:Z,aspectRatio:j,width:s,height:c,verticalPadding:o.IMAGE_PADDING.vertical,horizontalPadding:o.IMAGE_PADDING.horizontal,activeOverlayEditor:u,isEditing:f,brandingLogoAndSocials:w},(Q={activeOverlay:u||(k?d:void 0),featureConfig:i,fileInfo:m,fileMetadata:g,intl:S,imageUi:q,previewKey:l,previewMetadata:t,onFullSizeImageLoaded:K,onImageError:B,onSmallImageLoaded:W,pluginActivationParams:v},e=>{const{activeOverlay:t,pluginActivationParams:i,previewKey:a}=Q,n={imageLayer:P.createElement(N,{key:"image",...Q,...e})},r=O.map((e=>n[e])),l=o.isNestedArchiveFilePreviewKey(a),{imageUi:s}=Q;if(l)return r;if(null!=t&&void 0!==s){const a={previewType:o.PreviewType.Image,ui:s,layer:{dimensions:{width:e.originalWidth,height:e.originalHeight},viewportRef:e.layerViewportRef},displayLayers:n},{layerUI:{Layer:l}}=t;if(null!=l){const e=P.createElement(l,{...a,key:"plugin-layer",activationParams:i});return n.pluginOverlay=e,t.shouldReplacePreview?[e]:t.allowLayers?t.allowLayers.map((e=>n[e])):[...r,e]}}return r}))))):null;var Q},T=e=>{const{previewKey:t,onRenderSucceeded:i}=e,a=o.usePreviewState(t),n=o.useCurrentPreviewMetadata(),r=!!o.useActiveEditorId(),l=o.useRenderSucceededWithLogging(e.previewSessionId,i),s=o.useEditorActivationParams();return a?P.createElement(F,{...e,...a,onRenderSucceeded:l,isEditing:r,previewMetadata:n,pluginActivationParams:s}):P.createElement(o.LoadingIndicator,null)};T.displayName="PreviewImage",t.PreviewImage=T,t.UnconnectedPreviewImage=F}));
//# sourceMappingURL=c_file_viewer_preview_image.js-vflAcvWUf.map

//# debugId=97a32931-f10a-3744-afbd-48b94b94a186